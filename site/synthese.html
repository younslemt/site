<!DOCTYPE html>
<html lang="fr">
<head>
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-NVCZ7J5SD3"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-NVCZ7J5SD3');
  </script>

  <meta charset="UTF-8">
  <title>Votre Synth√®se ‚Äì Master Your Metrics</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f4f6f8;
      margin: 0;
      color: #333;
    }

    header {
      background: linear-gradient(135deg, #001f3f, #003a70);
      color: white;
      text-align: center;
      padding: 70px 20px;
    }

    header h1 {
      font-size: 2.6em;
      margin-bottom: 10px;
    }

    main {
      max-width: 950px;
      margin: 40px auto;
      padding: 0 20px;
    }

    .card {
      background: white;
      border-radius: 12px;
      padding: 35px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.08);
      margin-bottom: 40px;
    }

    .bar-block {
      margin-top: 18px;
    }

    .bar-label {
      font-weight: bold;
      margin-bottom: 8px;
    }

    .bar-bg {
      background: #ddd;
      border-radius: 30px;
      overflow: hidden;
      height: 28px;
    }

    .bar-fill {
      height: 28px;
      border-radius: 30px;
      line-height: 28px;
      font-weight: bold;
      color: white;
      padding-right: 12px;
      text-align: right;
      width: 0;
      transition: width 1s ease;
    }

    .score-global {
      text-align: center;
      font-size: 2em;
      margin: 20px 0 30px;
    }

    button {
      width: 100%;
      padding: 16px;
      margin-top: 12px;
      font-size: 1em;
      border-radius: 6px;
      border: none;
      cursor: pointer;
    }

    footer {
      text-align: center;
      padding: 30px;
      font-size: 0.9em;
      color: #666;
    }
  </style>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <!-- (ton 2e gtag existant - je le laisse identique) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-REMM660H7R"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-REMM660H7R');
  </script>
</head>

<body>

<header>
  <h1>Votre diagnostic est termin√©</h1>
  <p>Voici la synth√®se compl√®te de votre √©valuation.</p>
</header>

<main>

  <div class="card">
    <h2>üìä Vos r√©sultats par domaine</h2>
    <div id="generalScore" class="score-global"></div>

    <div class="bar-block">
      <div class="bar-label">üå± ESG</div>
      <div class="bar-bg"><div id="barESG" class="bar-fill" style="background:#2ECC40"></div></div>
    </div>

    <div class="bar-block">
      <div class="bar-label">üíº AML</div>
      <div class="bar-bg"><div id="barAML" class="bar-fill" style="background:#FF851B"></div></div>
    </div>

    <div class="bar-block">
      <div class="bar-label">üíª Digitalisation</div>
      <div class="bar-bg"><div id="barDigital" class="bar-fill" style="background:#7FDBFF"></div></div>
    </div>

    <div class="bar-block">
      <div class="bar-label">üìä Cr√©dit</div>
      <div class="bar-bg"><div id="barCredit" class="bar-fill" style="background:#B10DC9"></div></div>
    </div>

    <div class="bar-block">
      <div class="bar-label">üîê Cybers√©curit√©</div>
      <div class="bar-bg"><div id="barCyber" class="bar-fill" style="background:#FF4136"></div></div>
    </div>
  </div>

  <div class="card">
    <button onclick="generatePDF()" style="background:#28a745;color:white;">
      üìÑ T√©l√©charger mon diagnostic (PDF)
    </button>
    <button onclick="sendReport()" style="background:#0074D9;color:white;">
      üì® Envoyer ma scorecard par email
    </button>
  </div>

  <section class="card" style="border-left:6px solid #28a745;">
    <h2>üìÖ Un √©change strat√©gique de 30 minutes</h2>

    <p style="font-size:1.05em; line-height:1.6;">
      Ce diagnostic met en √©vidence des priorit√©s claires.
      <strong>Un √©change court permet de les traduire en d√©cisions concr√®tes</strong>,
      adapt√©es √† votre r√©alit√© √©conomique, r√©glementaire et op√©rationnelle.
    </p>

    <ul style="margin-top:20px; line-height:1.8;">
      <li>‚úîÔ∏è Lecture experte de vos scores et √©carts</li>
      <li>‚úîÔ∏è Identification des leviers √† impact rapide</li>
      <li>‚úîÔ∏è Orientation claire (quoi faire, quoi √©viter)</li>
    </ul>

    <a href="https://calendar.app.google/4E79ZUbDgHx2AMGe6"
      target="_blank" rel="noopener"
      style="
        display:inline-block;
        margin-top:25px;
        padding:16px 32px;
        background:#28a745;
        color:white;
        text-decoration:none;
        font-weight:bold;
        border-radius:8px;
        font-size:1.1em;
      ">
      üìÖ Planifier mon √©change strat√©gique
    </a>

    <p style="font-size:0.85em; color:#666; margin-top:10px;">
      Sans engagement ‚Ä¢ Approche pragmatique ‚Ä¢ Valeur imm√©diate
    </p>
  </section>

  <section class="card" style="border-left:6px solid #0074D9;">
    <h2>üöÄ Du diagnostic √† l‚Äôaction op√©rationnelle</h2>

    <p style="font-size:1.05em; line-height:1.6;">
      Le diagnostic est une photographie.
      <strong>Nos sprints d‚Äôaccompagnement transforment cette photographie en plan d‚Äôaction</strong>,
      prioris√©, mesurable et r√©aliste.
    </p>

    <ul style="margin-top:20px; line-height:1.8;">
      <li>‚úîÔ∏è Sprints ESG, AML/KYC, Digitalisation, Cr√©dit, Cybers√©curit√©</li>
      <li>‚úîÔ∏è Actions concr√®tes sur 30 √† 90 jours</li>
      <li>‚úîÔ∏è Livrables exploitables (policies, roadmap, preuves)</li>
      <li>‚úîÔ∏è Valorisation aupr√®s banques, clients et partenaires</li>
    </ul>

    <a href="services.html"
      style="
        display:inline-block;
        margin-top:25px;
        padding:14px 28px;
        background:#0074D9;
        color:white;
        text-decoration:none;
        font-weight:bold;
        border-radius:8px;
        font-size:1.05em;
      ">
      üîç D√©couvrir nos services & sprints
    </a>
  </section>

  <section class="card" style="text-align:center; background:#f9fafb;">
    <h2>üì¨ Une question ou un besoin sp√©cifique ?</h2>

    <p style="font-size:1.05em; line-height:1.6;">
      Chaque situation est diff√©rente.
      Si vous souhaitez poser une question, partager un contexte particulier
      ou v√©rifier la pertinence d‚Äôun accompagnement,
      <strong>√©crivez-nous directement</strong>.
    </p>

    <a href="mailto:contact@masteryourmetrics.be"
      style="
        display:inline-block;
        margin-top:20px;
        padding:14px 30px;
        background:#333;
        color:white;
        text-decoration:none;
        font-weight:bold;
        border-radius:8px;
      ">
      ‚úâÔ∏è Contacter Master Your Metrics
    </a>

    <p style="font-size:0.85em; color:#666; margin-top:12px;">
      R√©ponse humaine ‚Ä¢ Approche confidentielle ‚Ä¢ Orientation claire
    </p>
  </section>

</main>

<footer>
  <p>¬© 2025 Master Your Metrics ‚Äî Tous droits r√©serv√©s</p>
</footer>

<script>
/* =========================
   DONN√âES
========================= */
const scores = {
  ESG: Number(localStorage.getItem("scoreESG")) || 0,
  AML: Number(localStorage.getItem("scoreAML")) || 0,
  Digital: Number(localStorage.getItem("scoreDigital")) || 0,
  Credit: Number(localStorage.getItem("scoreCredit")) || 0,
  Cyber: Number(localStorage.getItem("scoreCyber")) || 0
};

const answersByDomain = {
  ESG: JSON.parse(localStorage.getItem("answersESG") || "[]"),
  AML: JSON.parse(localStorage.getItem("answersAML") || "[]"),
  Digital: JSON.parse(localStorage.getItem("answersDigital") || "[]"),
  Credit: JSON.parse(localStorage.getItem("answersCredit") || "[]"),
  Cyber: JSON.parse(localStorage.getItem("answersCyber") || "[]")
};

/* =========================
   AFFICHAGE SCORES
========================= */
function displayBar(id, value) {
  const el = document.getElementById(id);
  el.style.width = value + "%";
  el.textContent = value + " / 100";
}

displayBar("barESG", scores.ESG);
displayBar("barAML", scores.AML);
displayBar("barDigital", scores.Digital);
displayBar("barCredit", scores.Credit);
displayBar("barCyber", scores.Cyber);

const globalScore = Math.round(
  (scores.ESG + scores.AML + scores.Digital + scores.Credit + scores.Cyber) / 5
);

document.getElementById("generalScore").innerHTML =
  "‚≠ê".repeat(Math.round(globalScore / 20)) +
  "‚òÜ".repeat(5 - Math.round(globalScore / 20)) +
  `<div>Score global : ${globalScore} / 100</div>`;

/* =========================
   NORMALISATION PDF (SAFE)
   -> Corrige les soucis de texte/alignement
========================= */
function normalizeText(text) {
  if (!text) return "";

  return String(text)
    // remplace certains symboles par du texte simple
    .replace(/‚úÖ\s*/g, "- ")
    .replace(/‚ö†Ô∏è\s*/g, "- ")
    .replace(/‚ùå\s*/g, "- ")

    // guillemets / apostrophes "propres"
    .replace(/[‚Äú‚Äù]/g, '"')
    .replace(/[‚Äô‚Äò]/g, "'")

    // tirets et ellipses
    .replace(/‚Äì/g, "-")
    .replace(/‚Ä¶/g, "...")

    // supprime emojis r√©siduels (jsPDF peut bugger selon polices)
    .replace(/[\u{1F300}-\u{1FAFF}]/gu, "")

    // normalisation accents (jsPDF safe si tu veux rester en helvetica)
    .normalize("NFD")
    .replace(/[\u0300-\u036f]/g, "")

    .trim();
}

/* =========================
   INTERPRETATION GLOBALE (PRO)
========================= */
function interpretGlobal(score) {
  if (score < 30) {
    return "Niveau de maturite faible. Priorite: securiser les fondamentaux (process, preuves, gouvernance) et traiter les ecarts a risque eleve sur 30 jours.";
  }
  if (score < 70) {
    return "Niveau intermediaire. Des gains rapides sont possibles: formaliser, standardiser et documenter les points clefs afin d'augmenter la robustesse et la credibilite.";
  }
  return "Niveau solide. Priorite: consolider, industrialiser et valoriser le dispositif (preuves, indicateurs, communication) aupres des banques, clients et partenaires.";
}

/* =========================
   PRIORITES & QUICK WINS (PDF)
========================= */
function getSortedDomains(scoresObj) {
  return [
    ["ESG", scoresObj.ESG],
    ["AML/KYC", scoresObj.AML],
    ["Digitalisation", scoresObj.Digital],
    ["Credit", scoresObj.Credit],
    ["Cybersecurite", scoresObj.Cyber]
  ].sort((a,b) => a[1] - b[1]);
}

function quickWinsFor(domain) {
  const map = {
    "ESG": [
      "Structurer une fiche ESG 1 page (engagements, 3 indicateurs, responsable, frequence).",
      "Rassembler 5 preuves simples (factures, policies, attestations, photos, contrats).",
      "Mettre en place un tableau de suivi mensuel (KPI + actions + statut)."
    ],
    "AML/KYC": [
      "Standardiser l'onboarding: checklist KYC + piece d'identite + justificatifs + UBO.",
      "Mettre un scoring risque client simple (faible/moyen/eleve) et la rationale.",
      "Creer un registre de controles (revues periodiques, alertes, decisions, preuves)."
    ],
    "Digitalisation": [
      "Cartographier 3 processus critiques (onboarding, facturation, relances) et supprimer les doublons.",
      "Centraliser les documents (arborescence unique + nommage + droits d'acces).",
      "Mettre un mini-dashboard (delais, volume, incidents) pour piloter et prioriser."
    ],
    "Credit": [
      "Clarifier 3 ratios: tresorerie, BFR, capacite de remboursement (avec explication simple).",
      "Preparer une note bancaire 1 page (besoin, chiffres clefs, garanties, plan).",
      "Lister 5 actions court terme sur cash (relances, acomptes, stocks, conditions, charges)."
    ],
    "Cybersecurite": [
      "Activer MFA sur comptes critiques + gestionnaire de mots de passe.",
      "Verifier sauvegardes: frequence, restauration testee, separation des acces.",
      "Procedure incident 1 page: qui fait quoi, en combien de temps, preuves a conserver."
    ]
  };
  return map[domain] || [
    "Mettre a plat le processus, clarifier les roles et produire des preuves simples.",
    "Standardiser les documents et instaurer une routine de suivi.",
    "Mesurer 2 ou 3 indicateurs pour piloter sur 30 jours."
  ];
}

function pillarComment(label, value) {
  if (value < 30) return `${label}: ecarts importants. Priorite: formaliser et securiser les fondamentaux.`;
  if (value < 70) return `${label}: niveau intermediaire. Priorite: standardiser, documenter et fiabiliser.`;
  return `${label}: niveau solide. Priorite: consolider et valoriser le dispositif.`;
}

/* =========================
   PDF COMPLET (EXECUTIVE)
   -> Modifs UNIQUEMENT PDF:
      - textes pros
      - alignements propres (splitTextToSize)
      - suppression pages Q/R
========================= */
function generatePDF() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();

  const pageWidth = doc.internal.pageSize.getWidth();
  const pageHeight = doc.internal.pageSize.getHeight();
  const margin = 20;
  const maxWidth = pageWidth - margin * 2;
  let y = 20;

  const newPageIfNeeded = (h = 10) => {
    if (y + h > pageHeight - 18) {
      doc.addPage();
      y = 20;
    }
  };

  const writeParagraph = (text, fontSize = 11, lineGap = 5) => {
    doc.setFont("helvetica", "normal");
    doc.setFontSize(fontSize);
    const lines = doc.splitTextToSize(normalizeText(text), maxWidth);
    lines.forEach((line) => {
      newPageIfNeeded(lineGap + 2);
      doc.text(line, margin, y);
      y += lineGap;
    });
    y += 2;
  };

  const writeBullets = (items, fontSize = 10) => {
    doc.setFont("helvetica", "normal");
    doc.setFontSize(fontSize);
    items.forEach((it) => {
      const bullet = `- ${normalizeText(it)}`;
      const lines = doc.splitTextToSize(bullet, maxWidth);
      lines.forEach((line) => {
        newPageIfNeeded(5);
        doc.text(line, margin, y);
        y += 5;
      });
      y += 1;
    });
    y += 2;
  };

  /* =====================================================
     PAGE 1 ‚Äî COUVERTURE / SYNTH√àSE
  ===================================================== */
  doc.setFillColor(0, 58, 112);
  doc.rect(0, 0, pageWidth, 45, "F");

  doc.setTextColor(255);
  doc.setFont("helvetica", "bold");
  doc.setFontSize(22);
  doc.text("Master Your Metrics", pageWidth / 2, 25, { align: "center" });

  doc.setFontSize(11);
  doc.setFont("helvetica", "normal");
  doc.text("Diagnostic de pilotage ‚Äî Synthese decisionnelle", pageWidth / 2, 35, { align: "center" });

  doc.setTextColor(0);
  y = 60;

  // Carte Score global
  doc.setFillColor(245, 247, 250);
  doc.roundedRect(margin, y, maxWidth, 32, 6, 6, "F");

  doc.setFont("helvetica", "bold");
  doc.setFontSize(14);
  doc.text("Score global", margin + 10, y + 14);

  doc.setFontSize(22);
  doc.text(`${globalScore} / 100`, pageWidth - margin - 10, y + 18, { align: "right" });

  y += 45;

  // Lecture strategique
  doc.setFont("helvetica", "bold");
  doc.setFontSize(13);
  doc.text("Lecture strategique", margin, y);
  y += 8;

  writeParagraph(interpretGlobal(globalScore), 11, 5);

  // Scores par pilier (table)
  doc.setFont("helvetica", "bold");
  doc.setFontSize(13);
  doc.text("Scores par pilier", margin, y);
  y += 10;

  const pillars = [
    ["ESG", scores.ESG],
    ["AML / KYC", scores.AML],
    ["Digitalisation", scores.Digital],
    ["Credit", scores.Credit],
    ["Cybersecurite", scores.Cyber]
  ];

  pillars.forEach(([label, value]) => {
    newPageIfNeeded(14);

    doc.setFillColor(245, 247, 250);
    doc.roundedRect(margin, y - 6, maxWidth, 12, 4, 4, "F");

    doc.setFont("helvetica", "normal");
    doc.setFontSize(11);
    doc.text(label, margin + 6, y + 2);

    doc.setFont("helvetica", "bold");
    doc.text(`${value} / 100`, pageWidth - margin - 6, y + 2, { align: "right" });

    y += 16;
  });

  // Priorites + Quick wins (sur page 1 si place, sinon page 2)
  const sorted = getSortedDomains(scores);
  const top2 = sorted.slice(0, 2).map(d => d[0]);

  newPageIfNeeded(35);
  doc.setFont("helvetica", "bold");
  doc.setFontSize(13);
  doc.text("Priorites et quick wins (30 jours)", margin, y);
  y += 8;

  writeParagraph(
    `Priorites recommandees: ${top2.join(" / ")}. Objectif: reduire les ecarts critiques, produire des preuves et rendre le dispositif defendable (banques, clients, audit).`,
    11,
    5
  );

  top2.forEach((d) => {
    newPageIfNeeded(20);
    doc.setFont("helvetica", "bold");
    doc.setFontSize(11);
    doc.text(`${d} ‚Äî quick wins`, margin, y);
    y += 7;
    writeBullets(quickWinsFor(d), 10);
  });

  /* =====================================================
     PAGE 2 ‚Äî COMMENTAIRES PAR PILIER (sans Q/R)
  ===================================================== */
  doc.addPage();
  y = 28;

  doc.setFont("helvetica", "bold");
  doc.setFontSize(16);
  doc.text("Commentaire par pilier", margin, y);
  y += 12;

  pillars.forEach(([label, value]) => {
    newPageIfNeeded(26);
    doc.setFont("helvetica", "bold");
    doc.setFontSize(12);
    doc.text(`${label} ‚Äî ${value}/100`, margin, y);
    y += 7;

    writeParagraph(pillarComment(label, value), 10, 5);

    // 2 actions concretes rapides
    const key = label.includes("AML") ? "AML/KYC"
              : label.includes("Cyber") ? "Cybersecurite"
              : label.includes("Credit") ? "Credit"
              : label.includes("Digital") ? "Digitalisation"
              : "ESG";

    const actions = quickWinsFor(key).slice(0, 2);
    writeBullets(actions, 10);

    y += 2;
  });

  /* =====================================================
     PAGE FINALE ‚Äî CONTACT
  ===================================================== */
  doc.addPage();
  y = 40;

  doc.setFont("helvetica", "bold");
  doc.setFontSize(16);
  doc.text("Prochaine etape", margin, y);
  y += 12;

  writeParagraph(
    "Ce diagnostic constitue une base objective de discussion. Un echange structure permet de transformer ces constats en plan d'actions concret, priorise et mesurable. Sur base de vos scores, nous recommandons de demarrer par les deux priorites identifiees, puis d'industrialiser le dispositif.",
    11,
    5
  );

  y += 10;

  doc.setFillColor(0, 116, 217);
  doc.roundedRect(margin, y, maxWidth, 36, 6, 6, "F");

  doc.setTextColor(255);
  doc.setFont("helvetica", "bold");
  doc.setFontSize(13);
  doc.text("Contact", margin + 10, y + 14);

  doc.setFont("helvetica", "normal");
  doc.setFontSize(11);
  doc.text(
    "Master Your Metrics\ncontact@masteryourmetrics.be\nwww.masteryourmetrics.be",
    margin + 10,
    y + 26
  );

  doc.setTextColor(0);

  // Footer
  doc.setFontSize(8);
  doc.setTextColor(130);
  doc.text("Document confidentiel ‚Äî usage decisionnel", pageWidth / 2, pageHeight - 10, { align: "center" });

  doc.save("MasterYourMetrics_Diagnostic_Executive.pdf");
}

/* =========================
   EMAIL ‚Äì VERSION CTA CLIENT
========================= */
function sendReport() {
  const recipient = "contact@masteryourmetrics.be";
  const subject = "Votre scorecard ‚Äì Prochaines √©tapes possibles";

  const body = `
Bonjour,

Vous venez de finaliser votre diagnostic Master Your Metrics.

Voici votre synthese :

Score global : ${globalScore}/100

- ESG : ${scores.ESG}/100
- AML / KYC : ${scores.AML}/100
- Digitalisation : ${scores.Digital}/100
- Credit : ${scores.Credit}/100
- Cybersecurite : ${scores.Cyber}/100

Lecture rapide :
${interpretGlobal(globalScore)}

Prochaine etape recommandee (sans engagement) :
Un echange strategique de 30 minutes pour clarifier vos priorites et transformer ce diagnostic en plan concret.

Planifier un echange :
https://calendar.app.google/TWzExGsSew5rCkN77

Ou decouvrir nos accompagnements :
https://master-metrics.vercel.app/services.html

Bien cordialement,

Master Your Metrics
contact@masteryourmetrics.be
https://masteryourmetrics.be
`.trim();

  const url =
    "mailto:" + recipient +
    "?subject=" + encodeURIComponent(subject) +
    "&body=" + encodeURIComponent(body);

  window.location.href = url;
}
</script>

</body>
</html>
