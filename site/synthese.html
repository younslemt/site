<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Votre Synth√®se ‚Äì Master Your Metrics</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body {
  font-family: Arial, sans-serif;
  background-color: #f4f6f8;
  margin: 0;
  color: #333;
}

header {
  background: linear-gradient(135deg, #001f3f, #003a70);
  color: white;
  text-align: center;
  padding: 70px 20px;
}

header h1 {
  font-size: 2.6em;
  margin-bottom: 10px;
}

main {
  max-width: 950px;
  margin: 40px auto;
  padding: 0 20px;
}

.card {
  background: white;
  border-radius: 12px;
  padding: 35px;
  box-shadow: 0 6px 18px rgba(0,0,0,0.08);
  margin-bottom: 40px;
}

.bar-block {
  margin-top: 18px;
}

.bar-label {
  font-weight: bold;
  margin-bottom: 8px;
}

.bar-bg {
  background: #ddd;
  border-radius: 30px;
  overflow: hidden;
  height: 28px;
}

.bar-fill {
  height: 28px;
  border-radius: 30px;
  line-height: 28px;
  font-weight: bold;
  color: white;
  padding-right: 12px;
  text-align: right;
  width: 0;
  transition: width 1s ease;
}

.score-global {
  text-align: center;
  font-size: 2em;
  margin: 20px 0 30px;
}

button {
  width: 100%;
  padding: 16px;
  margin-top: 12px;
  font-size: 1em;
  border-radius: 6px;
  border: none;
  cursor: pointer;
}

footer {
  text-align: center;
  padding: 30px;
  font-size: 0.9em;
  color: #666;
}
</style>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>

<body>

<header>
  <h1>Votre diagnostic est termin√©</h1>
  <p>Voici la synth√®se compl√®te de votre √©valuation.</p>
</header>

<main>

<div class="card">
  <h2>üìä Vos r√©sultats par domaine</h2>
  <div id="generalScore" class="score-global"></div>

  <div class="bar-block">
    <div class="bar-label">üå± ESG</div>
    <div class="bar-bg"><div id="barESG" class="bar-fill" style="background:#2ECC40"></div></div>
  </div>

  <div class="bar-block">
    <div class="bar-label">üíº AML</div>
    <div class="bar-bg"><div id="barAML" class="bar-fill" style="background:#FF851B"></div></div>
  </div>

  <div class="bar-block">
    <div class="bar-label">üíª Digitalisation</div>
    <div class="bar-bg"><div id="barDigital" class="bar-fill" style="background:#7FDBFF"></div></div>
  </div>

  <div class="bar-block">
    <div class="bar-label">üìä Cr√©dit</div>
    <div class="bar-bg"><div id="barCredit" class="bar-fill" style="background:#B10DC9"></div></div>
  </div>

  <div class="bar-block">
    <div class="bar-label">üîê Cybers√©curit√©</div>
    <div class="bar-bg"><div id="barCyber" class="bar-fill" style="background:#FF4136"></div></div>
  </div>
</div>

<div class="card">
  <button onclick="generatePDF()" style="background:#28a745;color:white;">
    üìÑ T√©l√©charger mon diagnostic (PDF)
  </button>
  <button onclick="sendReport()" style="background:#0074D9;color:white;">
    üì® Envoyer ma scorecard par email
  </button>
</div>

</main>

<footer>
  <p>¬© 2025 Master Your Metrics ‚Äî Tous droits r√©serv√©s</p>
</footer>

<script>
/* =========================
   DONN√âES
========================= */
const scores = {
  ESG: Number(localStorage.getItem("scoreESG")) || 0,
  AML: Number(localStorage.getItem("scoreAML")) || 0,
  Digital: Number(localStorage.getItem("scoreDigital")) || 0,
  Credit: Number(localStorage.getItem("scoreCredit")) || 0,
  Cyber: Number(localStorage.getItem("scoreCyber")) || 0
};

const answersByDomain = {
  ESG: JSON.parse(localStorage.getItem("answersESG") || "[]"),
  AML: JSON.parse(localStorage.getItem("answersAML") || "[]"),
  Digital: JSON.parse(localStorage.getItem("answersDigital") || "[]"),
  Credit: JSON.parse(localStorage.getItem("answersCredit") || "[]"),
  Cyber: JSON.parse(localStorage.getItem("answersCyber") || "[]")
};

/* =========================
   AFFICHAGE SCORES
========================= */
function displayBar(id, value) {
  const el = document.getElementById(id);
  el.style.width = value + "%";
  el.textContent = value + " / 100";
}

displayBar("barESG", scores.ESG);
displayBar("barAML", scores.AML);
displayBar("barDigital", scores.Digital);
displayBar("barCredit", scores.Credit);
displayBar("barCyber", scores.Cyber);

const globalScore = Math.round(
  (scores.ESG + scores.AML + scores.Digital + scores.Credit + scores.Cyber) / 5
);

document.getElementById("generalScore").innerHTML =
  "‚≠ê".repeat(Math.round(globalScore / 20)) +
  "‚òÜ".repeat(5 - Math.round(globalScore / 20)) +
  `<div>Score global : ${globalScore} / 100</div>`;

/* =========================
   NORMALISATION PDF
========================= */
function normalizeText(text) {
  return (text || "")
    .replace(/‚úÖ/g,"OUI")
    .replace(/‚ö†Ô∏è/g,"PARTIEL")
    .replace(/‚ùå/g,"NON")
    .normalize("NFD").replace(/[\u0300-\u036f]/g,"");
}

/* =========================
   PDF COMPLET
========================= */
function generatePDF() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  let y = 20;
  const w = doc.internal.pageSize.getWidth() - 40;

  doc.setFont("helvetica","bold");
  doc.setFontSize(18);
  doc.text("Master Your Metrics",105,y,{align:"center"});
  y+=10;

  doc.setFontSize(12);
  doc.text(`Score global : ${globalScore}/100`,20,y);
  y+=10;

  Object.entries(answersByDomain).forEach(([domain,answers])=>{
    if(!answers.length) return;
    doc.addPage(); y=20;
    doc.setFont("helvetica","bold");
    doc.text(domain,20,y); y+=8;
    doc.setFont("helvetica","normal");
    answers.forEach((a,i)=>{
      const txt = `${i+1}. ${normalizeText(a.question)}\n‚Üí ${normalizeText(a.answer)}`;
      const h = doc.getTextDimensions(txt,{maxWidth:w}).h;
      if(y+h>270){doc.addPage();y=20;}
      doc.text(txt,20,y,{maxWidth:w});
      y+=h+6;
    });
  });

  doc.save("MasterYourMetrics_Diagnostic_Complet.pdf");
}

/* =========================
   EMAIL
========================= */
function sendReport() {
  const body = `
Score global : ${globalScore}/100

ESG : ${scores.ESG}
AML : ${scores.AML}
Digital : ${scores.Digital}
Cr√©dit : ${scores.Credit}
Cyber : ${scores.Cyber}
`;
  window.location.href =
    "mailto:masteryourmetrics@gmail.com" +
    "?subject=Ma Scorecard Master Your Metrics" +
    "&body=" + encodeURIComponent(body);
}
</script>

</body>
</html>