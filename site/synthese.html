<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Votre Synth√®se ‚Äì Master Your Metrics</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body {
  font-family: Arial, sans-serif;
  background-color: #f4f6f8;
  margin: 0;
  color: #333;
}

header {
  background: linear-gradient(135deg, #001f3f, #003a70);
  color: white;
  text-align: center;
  padding: 70px 20px;
}

header h1 {
  font-size: 2.6em;
  margin-bottom: 10px;
}

main {
  max-width: 950px;
  margin: 40px auto;
  padding: 0 20px;
}

.card {
  background: white;
  border-radius: 12px;
  padding: 35px;
  box-shadow: 0 6px 18px rgba(0,0,0,0.08);
  margin-bottom: 40px;
}

.bar-block {
  margin-top: 18px;
}

.bar-label {
  font-weight: bold;
  margin-bottom: 8px;
}

.bar-bg {
  background: #ddd;
  border-radius: 30px;
  overflow: hidden;
  height: 28px;
}

.bar-fill {
  height: 28px;
  border-radius: 30px;
  line-height: 28px;
  font-weight: bold;
  color: white;
  padding-right: 12px;
  text-align: right;
  width: 0;
  transition: width 1s ease;
}

.score-global {
  text-align: center;
  font-size: 2em;
  margin: 20px 0 30px;
}

button {
  width: 100%;
  padding: 16px;
  margin-top: 12px;
  font-size: 1em;
  border-radius: 6px;
  border: none;
  cursor: pointer;
}

footer {
  text-align: center;
  padding: 30px;
  font-size: 0.9em;
  color: #666;
}
</style>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>

<body>

<header>
  <h1>Votre diagnostic est termin√©</h1>
  <p>Voici la synth√®se compl√®te de votre √©valuation.</p>
</header>

<main>

<div class="card">
  <h2>üìä Vos r√©sultats par domaine</h2>
  <div id="generalScore" class="score-global"></div>

  <div class="bar-block">
    <div class="bar-label">üå± ESG</div>
    <div class="bar-bg"><div id="barESG" class="bar-fill" style="background:#2ECC40"></div></div>
  </div>

  <div class="bar-block">
    <div class="bar-label">üíº AML</div>
    <div class="bar-bg"><div id="barAML" class="bar-fill" style="background:#FF851B"></div></div>
  </div>

  <div class="bar-block">
    <div class="bar-label">üíª Digitalisation</div>
    <div class="bar-bg"><div id="barDigital" class="bar-fill" style="background:#7FDBFF"></div></div>
  </div>

  <div class="bar-block">
    <div class="bar-label">üìä Cr√©dit</div>
    <div class="bar-bg"><div id="barCredit" class="bar-fill" style="background:#B10DC9"></div></div>
  </div>

  <div class="bar-block">
    <div class="bar-label">üîê Cybers√©curit√©</div>
    <div class="bar-bg"><div id="barCyber" class="bar-fill" style="background:#FF4136"></div></div>
  </div>
</div>

<div class="card">
  <button onclick="generatePDF()" style="background:#28a745;color:white;">
    üìÑ T√©l√©charger mon diagnostic (PDF)
  </button>
  <button onclick="sendReport()" style="background:#0074D9;color:white;">
    üì® Envoyer ma scorecard par email
  </button>
</div>

</main>

<footer>
  <p>¬© 2025 Master Your Metrics ‚Äî Tous droits r√©serv√©s</p>
</footer>

<script>
/* =========================
   DONN√âES
========================= */
const scores = {
  ESG: Number(localStorage.getItem("scoreESG")) || 0,
  AML: Number(localStorage.getItem("scoreAML")) || 0,
  Digital: Number(localStorage.getItem("scoreDigital")) || 0,
  Credit: Number(localStorage.getItem("scoreCredit")) || 0,
  Cyber: Number(localStorage.getItem("scoreCyber")) || 0
};

const answersByDomain = {
  ESG: JSON.parse(localStorage.getItem("answersESG") || "[]"),
  AML: JSON.parse(localStorage.getItem("answersAML") || "[]"),
  Digital: JSON.parse(localStorage.getItem("answersDigital") || "[]"),
  Credit: JSON.parse(localStorage.getItem("answersCredit") || "[]"),
  Cyber: JSON.parse(localStorage.getItem("answersCyber") || "[]")
};

/* =========================
   AFFICHAGE SCORES
========================= */
function displayBar(id, value) {
  const el = document.getElementById(id);
  el.style.width = value + "%";
  el.textContent = value + " / 100";
}

displayBar("barESG", scores.ESG);
displayBar("barAML", scores.AML);
displayBar("barDigital", scores.Digital);
displayBar("barCredit", scores.Credit);
displayBar("barCyber", scores.Cyber);

const globalScore = Math.round(
  (scores.ESG + scores.AML + scores.Digital + scores.Credit + scores.Cyber) / 5
);

document.getElementById("generalScore").innerHTML =
  "‚≠ê".repeat(Math.round(globalScore / 20)) +
  "‚òÜ".repeat(5 - Math.round(globalScore / 20)) +
  `<div>Score global : ${globalScore} / 100</div>`;

/* =========================
   NORMALISATION PDF
========================= */
function normalizeText(text) {
  return (text || "")
    .replace(/‚úÖ/g,"OUI")
    .replace(/‚ö†Ô∏è/g,"PARTIEL")
    .replace(/‚ùå/g,"NON")
    .normalize("NFD").replace(/[\u0300-\u036f]/g,"");
}

/* =========================
   PDF COMPLET
========================= */
function generatePDF() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();

  const pageWidth = doc.internal.pageSize.getWidth();
  const pageHeight = doc.internal.pageSize.getHeight();
  const margin = 20;
  const maxWidth = pageWidth - margin * 2;
  let y = 20;

  const newPageIfNeeded = (h = 10) => {
    if (y + h > pageHeight - 20) {
      doc.addPage();
      y = 20;
    }
  };

  /* =====================================================
     PAGE 1 ‚Äî COUVERTURE / SYNTH√àSE
  ===================================================== */

  // Bandeau haut
  doc.setFillColor(0, 58, 112);
  doc.rect(0, 0, pageWidth, 45, "F");

  doc.setTextColor(255);
  doc.setFont("helvetica", "bold");
  doc.setFontSize(22);
  doc.text("Master Your Metrics", pageWidth / 2, 25, { align: "center" });

  doc.setFontSize(11);
  doc.setFont("helvetica", "normal");
  doc.text(
    "Diagnostic de pilotage ‚Äî Synth√®se d√©cisionnelle",
    pageWidth / 2,
    35,
    { align: "center" }
  );

  doc.setTextColor(0);
  y = 60;

  // Carte Score global
  doc.setFillColor(245, 247, 250);
  doc.roundedRect(margin, y, maxWidth, 32, 6, 6, "F");

  doc.setFont("helvetica", "bold");
  doc.setFontSize(14);
  doc.text("Score global", margin + 10, y + 14);

  doc.setFontSize(22);
  doc.text(`${globalScore} / 100`, pageWidth - margin - 10, y + 18, {
    align: "right"
  });

  y += 45;

  // Lecture strat√©gique
  doc.setFontSize(13);
  doc.setFont("helvetica", "bold");
  doc.text("Lecture strat√©gique", margin, y);

  y += 8;
  doc.setFont("helvetica", "normal");
  doc.setFontSize(11);
  doc.text(
    normalizeText(interpretGlobal(globalScore)),
    margin,
    y,
    { maxWidth }
  );

  y += 20;

  /* =====================================================
     SCORES PAR PILIER
  ===================================================== */

  doc.setFont("helvetica", "bold");
  doc.setFontSize(13);
  doc.text("Scores par pilier", margin, y);
  y += 10;

  const pillars = [
    ["ESG", scores.ESG],
    ["AML / KYC", scores.AML],
    ["Digitalisation", scores.Digital],
    ["Cr√©dit", scores.Credit],
    ["Cybers√©curit√©", scores.Cyber]
  ];

  pillars.forEach(([label, value]) => {
    newPageIfNeeded(14);

    // fond ligne
    doc.setFillColor(245, 247, 250);
    doc.roundedRect(margin, y - 6, maxWidth, 12, 4, 4, "F");

    doc.setFont("helvetica", "normal");
    doc.setFontSize(11);
    doc.text(label, margin + 6, y + 2);

    doc.setFont("helvetica", "bold");
    doc.text(`${value} / 100`, pageWidth - margin - 6, y + 2, {
      align: "right"
    });

    y += 16;
  });

  /* =====================================================
     QUESTIONNAIRE COMPLET
  ===================================================== */

  Object.entries(answersByDomain).forEach(([domain, answers]) => {
    if (!answers || answers.length === 0) return;

    doc.addPage();
    y = 30;

    doc.setFont("helvetica", "bold");
    doc.setFontSize(16);
    doc.text(domain, margin, y);

    y += 10;

    doc.setFont("helvetica", "normal");
    doc.setFontSize(10);

    answers.forEach((item, i) => {
      const question = normalizeText(item.question);
      const answer = normalizeText(item.answer);

      const block = `${i + 1}. ${question}\n‚Üí ${answer}`;
      const h = doc.getTextDimensions(block, { maxWidth }).h;

      newPageIfNeeded(h + 10);

      doc.setFillColor(250, 250, 250);
      doc.roundedRect(margin, y - 4, maxWidth, h + 6, 4, 4, "F");

      doc.text(block, margin + 4, y, { maxWidth });
      y += h + 12;
    });
  });

  /* =====================================================
     PAGE FINALE ‚Äî CONTACT
  ===================================================== */

  doc.addPage();
  y = 50;

  doc.setFont("helvetica", "bold");
  doc.setFontSize(16);
  doc.text("Prochaine √©tape", margin, y);

  y += 10;
  doc.setFont("helvetica", "normal");
  doc.setFontSize(11);
  doc.text(
    "Ce diagnostic constitue une base objective de discussion. " +
    "Un √©change structur√© permet de transformer ces constats " +
    "en plan d‚Äôactions concret, prioris√© et mesurable.",
    margin,
    y,
    { maxWidth }
  );

  y += 30;

  doc.setFillColor(0, 116, 217);
  doc.roundedRect(margin, y, maxWidth, 30, 6, 6, "F");

  doc.setTextColor(255);
  doc.setFont("helvetica", "bold");
  doc.text("Contact", margin + 10, y + 12);

  doc.setFont("helvetica", "normal");
  doc.text(
    "Master Your Metrics\nmasteryourmetrics@gmail.com\nwww.master-metrics.vercel.app",
    margin + 10,
    y + 22
  );

  doc.setTextColor(0);

  /* FOOTER */
  doc.setFontSize(8);
  doc.setTextColor(130);
  doc.text(
    "Document confidentiel ‚Äî usage d√©cisionnel",
    pageWidth / 2,
    pageHeight - 10,
    { align: "center" }
  );

  doc.save("MasterYourMetrics_Diagnostic_Executive.pdf");
}

/* =========================
   EMAIL
========================= */
function sendReport() {
  const body = `
Score global : ${globalScore}/100

ESG : ${scores.ESG}
AML : ${scores.AML}
Digital : ${scores.Digital}
Cr√©dit : ${scores.Credit}
Cyber : ${scores.Cyber}
`;
  window.location.href =
    "mailto:masteryourmetrics@gmail.com" +
    "?subject=Ma Scorecard Master Your Metrics" +
    "&body=" + encodeURIComponent(body);
}
</script>

</body>
</html>
